ifdef debug
static = static
DEBUG_INFORMATION_FLAG = -g
endif

CC = gcc

OPTIMIZE_FLAG = -O0
WARNING_EQUALLY_ERROR_FLAG = -Werror

COMPILE_FLAGS = -std=c99 -Wall $(WARNING_EQUALLY_ERROR_FLAG) $(OPTIMIZE_FLAG) $(DEBUG_INFORMATION_FLAG)
LIBRARY_LOCATION_FLAG = -L

SOURCE_PATH = src
BUILD_PATH = build
BINARY_PATH = bin
LIBRARY_PATH = library

PREFIX_FILE_LIBRARY = lib

MAIN_FILE = main

BINARY_KEY_START = key

EXTENSION_FILE_C_CODE = .c
EXTENSION_FILE_OBJECT = .o
EXTENSION_FILE_STATIC_LIBRARY = .a
EXTENSION_FILE_DYNAMIC_LIBRARY = .so

SOURCES = $(shell find $(SOURCE_PATH)/ -name '*$(EXTENSION_FILE_C_CODE)')

OBJECTS = $(SOURCES:$(SOURCE_PATH)/%$(EXTENSION_FILE_C_CODE)=$(BUILD_PATH)/%$(EXTENSION_FILE_OBJECT))

LIB_SOURCES = $(filter-out $(SOURCE_PATH)/$(MAIN_FILE)$(EXTENSION_FILE_C_CODE), $(SOURCES))

ifdef static
LIBS = $(LIB_SOURCES:$(SOURCE_PATH)/%$(EXTENSION_FILE_C_CODE)=$(LIBRARY_PATH)/$(PREFIX_FILE_LIBRARY)%$(EXTENSION_FILE_STATIC_LIBRARY))
else

RELATIVE_ADRESSING_FLAG = -fPIC

LD_LIBRARY_PATH=$(pwd)/(LIBRARY_PATH)

LIBS = $(LIB_SOURCES:$(SOURCE_PATH)/%$(EXTENSION_FILE_C_CODE)=$(LIBRARY_PATH)/$(PREFIX_FILE_LIBRARY)%$(EXTENSION_FILE_DYNAMIC_LIBRARY))
endif

.PHONY: clean all make_path run

all: make_path $(BINARY_PATH)/$(BINARY_KEY_START)

ifdef static
$(BINARY_PATH)/$(BINARY_KEY_START): $(BUILD_PATH)/main$(EXTENSION_FILE_OBJECT) $(LIBS)
	$(CC) $(COMPILE_FLAGS) $(LIBRARY_LOCATION_FLAG)$(LIBRARY_PATH) $(BUILD_PATH)/main$(EXTENSION_FILE_OBJECT) -o $(BINARY_PATH)/$(BINARY_KEY_START) $(LIBS)

$(LIBRARY_PATH)/$(PREFIX_FILE_LIBRARY)%$(EXTENSION_FILE_STATIC_LIBRARY): $(BUILD_PATH)/%$(EXTENSION_FILE_OBJECT)
	ar rc $@ $^

$(BUILD_PATH)/%$(EXTENSION_FILE_OBJECT): $(SOURCE_PATH)/%$(EXTENSION_FILE_C_CODE)
	$(CC) $(COMPILE_FLAGS) $< -c -o $@
else

$(BINARY_PATH)/$(BINARY_KEY_START): $(BUILD_PATH)/main$(EXTENSION_FILE_OBJECT) $(LIBS)
	$(CC) $(COMPILE_FLAGS) $(LIBRARY_LOCATION_FLAG)$(LIBRARY_PATH) $(BUILD_PATH)/main$(EXTENSION_FILE_OBJECT) -o $(BINARY_PATH)/$(BINARY_KEY_START) $(LIBS)

$(LIBRARY_PATH)/$(PREFIX_FILE_LIBRARY)%$(EXTENSION_FILE_DYNAMIC_LIBRARY): $(BUILD_PATH)/%$(EXTENSION_FILE_OBJECT)
	gcc -shared $^ -o $@

$(BUILD_PATH)/%$(EXTENSION_FILE_OBJECT): $(SOURCE_PATH)/%$(EXTENSION_FILE_C_CODE)
	$(CC) $(COMPILE_FLAGS) $< $(RELATIVE_ADRESSING_FLAG) -c -o $@
endif

make_path:
	mkdir $(BINARY_PATH) -p
	mkdir $(BUILD_PATH) -p
	mkdir $(LIBRARY_PATH) -p

clean:
	rm -rf $(BINARY_PATH)
	rm -rf $(BUILD_PATH)
	rm -rf $(LIBRARY_PATH)

run:
	$(LD_FLAG) ./$(BINARY_PATH)/$(BINARY_KEY_START)